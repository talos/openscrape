/***
   * Copyright (c) 2012 John Krauss.
   *
   * This file is part of Openscrape.
   *
   * Openscrape is free software: you can redistribute it and/or modify
   * it under the terms of the GNU General Public License as published by
   * the Free Software Foundation, either version 3 of the License, or
   * (at your option) any later version.
   *
   * Openscrape is distributed in the hope that it will be useful,
   * but WITHOUT ANY WARRANTY; without even the implied warranty of
   * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
   * GNU General Public License for more details.
   *
   * You should have received a copy of the GNU General Public License
   * along with Openscrape.  If not, see <http://www.gnu.org/licenses/>.
   *
   ***/var openscrape;openscrape||(openscrape={}),function(){var a={},b=function(b,d,e,f){a.hasOwnProperty(d)||(a[d]={}),a[d][e]=b(c(d,e),f)},c=function(b,c){return a.hasOwnProperty(b)?a[b][c]:undefined},d=function(a,b){return b},e=function(a,b){return _.extend(a===null||typeof a=="undefined"?{}:a,b)},f=function(a,b,c){do b=a(b,c);while((c=g(c))!==undefined);return b},g=function(a){return c("parent",a)};openscrape.data={newId:function(a){return id=_.uniqueId("response"),b(d,"parent",id,a),id},getParent:g,getRoot:function(a){return f(function(a,b){return b},null,a)},getResponse:function(a){return c("response",a)},getTags:function(a){return f(function(a,b){var d=c("response",b),e=c("tags",b);return _.isUndefined(e)||(a=_.extend({},e,a)),a},{},a)},getCookies:function(a){return f(function(a,b){var d=c("response",b);return _.isUndefined(d)||d.hasOwnProperty("cookie")&&_.each(d.cookies,function(b,c){a.hasOwnProperty(c)?a.host=a.host.concat(b):a.host=b}),a},{},a)},saveTags:function(a,c){b(e,"tags",a,c)},saveTag:function(a,b,c){var d={};d[b]=c,this.saveTags(a,d)},saveResponse:function(a,c){c.id=a;if(c.hasOwnProperty("children")){var e=[],f=this,g=_.size(c.children)>1;_.each(c.children,function(b,d){var h=[],i=f.newId(a);c.status==="found"&&f.saveTag(g?i:f.getParent(a),c.name,d),_.each(b,function(a){var b=f.newId(i);f.saveResponse(b,a),h.push(b)}),e.push({name:d,id:i,childIds:h})}),c.children=e}else c.children=[];b(d,"response",a,c)}}}();var openscrape;openscrape||(openscrape={}),function(){openscrape["interface"]=function(a,b,c,d,e,f,g,h){var i=d3.select(b).append("svg").attr("width",a*2).attr("height",a*2),h="viewport",j=i.append("g").attr("id",h);$(i).svgPan(h),openscrape.mouse.init($(g)),$(c).submit(function(){try{var b=$(d).val(),c=openscrape.data.newId();openscrape.data.saveTags(c,JSON.parse($(e).val())),openscrape.request(c,b,!0,window.location.href).done(function(b){openscrape.data.saveResponse(c,b),openscrape.visualize(j,c,a,a,a)})}catch(f){f instanceof SyntaxError?openscrape.warn("Bad JSON for tags: "+f.message):(openscrape.warn("Unknown error constructing request: "+f.message),console.log(f.stack))}return!1}),$(f).click(function(){var a=_.reduce(document.styleSheets,function(a,b){return b.disabled===!1?a+css2txt(b):a},"");$(i).attr("xmlns","http://www.w3.org/2000/svg").attr("xmlns:xlink","http://www.w3.org/1999/xlink").prepend($("<style />").attr("type","text/css").text("<![CDATA[  "+a+"  ]]>")).download(openscrape.warn)})}}();var openscrape;openscrape||(openscrape={}),function(){var a=$(),b=0,c=0;openscrape.mouse={init:function(d,e,f){if(a.length>0)return;a=$(d),b=e,c=f,$("body").bind("mousemove",function(b){a.is(":visible")&&a.css({left:b.pageX+"px",top:b.pageY+"px"})})},_resize:function(){a.rescale(b,c,!1,-1)},setText:function(b){a.empty().text(b),this._resize()},setHTML:function(b){var c=$("<div />").html(b);c.find("title").remove(),a.empty().append(c),this._resize()},show:function(){a.show()},hide:function(){a.hide()}}}();var openscrape;openscrape||(openscrape={}),function(){var a=$({}),b="/request";$.ajaxSetup({timeout:4e4}),openscrape.request=function(c,d,e,f,g){var h=$.Deferred();return a.queue("caustic",function(){$.post(b,JSON.stringify({id:c,uri:f,instruction:d,cookies:openscrape.data.getCookies(c),tags:openscrape.data.getTags(c),input:g,force:String(e)})).done(function(a,b,c){h.resolve(JSON.parse(c.responseText))}).fail(function(a){openscrape.warn("Request for "+d+" failed: "+a.statusText),h.reject(a)}).always(function(){a.dequeue("caustic")})}),a.queue("caustic").length==1&&a.dequeue("caustic"),h.promise()}}();var openscrape;openscrape||(openscrape={}),function(){openscrape.visualize=function(a,b,c,d,e){var f=a.append("g").attr("id","viewport").attr("transform","translate("+c+","+d+")"),g=d3.layout.tree().size([360,e-120]).separation(function(a,b){return(a.parent==b.parent?1:2)/a.depth}).children(function(a){return a.hasOwnProperty("childIds")?_.map(a.childIds,function(a){return openscrape.data.getResponse(a)}):a.children}),h=d3.svg.diagonal.radial().projection(function(a){return[a.y,a.x/180*Math.PI]});origin=d3.svg.diagonal.radial().projection(function(a){return[0,0]}),onClick=function(a,b){var c=d3.select(d3.event.target);if(a.status==="wait"||a.status==="missing"){var d=c.style("fill"),e=c.select("animate"),f=c.append("animate").attr("attributeType","CSS").attr("attributeName","fill").attr("values","#fff;#f00;#fff").attr("repeatCount","indefinite").attr("dur","2s").attr("begin","0s"),g=e.attr("values");e.attr("values","8;16;8"),openscrape.request(a.id,a.instruction,!0,a.uri).done(function(b){e.attr("values",g),c.style("fill",d),f.remove(),_.extend(a,b),openscrape.data.saveResponse(a.id,b),redraw()})}else a.status==="loaded"&&(a.children=[],a.status="wait",openscrape.data.saveResponse(a.id,a),redraw())},onMouseover=function(a,b){if(a.hasOwnProperty("name"))openscrape.mouse.setHTML(a.name);else if(a.status==="missing")openscrape.mouse.setText(JSON.stringify(a.missing));else if(a.status==="failed")openscrape.mouse.setText(JSON.stringify(a.failed));else return;openscrape.mouse.show()},onMouseout=function(a,b){openscrape.mouse.hide()},redraw=function(){var a=g.nodes(openscrape.data.getResponse(b)),c=f.selectAll("path.link").data(g.links(a),function(a){return a.source.id+"_"+a.target.id});c.enter().append("path").attr("d",origin).attr("class","link"),c.transition().duration(1e3).attr("d",h);var d=f.selectAll("g.node").data(a,function(a){return a.id}),e=d.enter().append("g").attr("class",function(a){return a.hasOwnProperty("status")?"node "+a.status:"branch node"});e.append("circle").attr("r",4.5).on("click",function(a,b){onClick(a,b)}).on("mouseover",function(a,b){onMouseover(a,b)}).on("mouseout",function(a,b){onMouseout(a,b)}),e.selectAll(".wait circle,.missing circle").append("animate").attr("attributeType","XML").attr("attributeName","r").attr("values","5;8;5").attr("repeatCount","indefinite").attr("dur","2s").attr("begin","0s"),e.append("text").attr("dx",function(a){return a.x<180?8:-8}).attr("dy",".31em").attr("text-anchor",function(a){return a.x<180?"start":"end"}).attr("transform",function(a){return a.x<180?null:"rotate(180)"}).text(function(a){return a.hasOwnProperty("name")?a.name.length<20?a.name:a.name.substr(0,17)+"...":"???"}),d.transition().duration(1e3).attr("transform",function(a){return"rotate("+(a.x-90)+")translate("+a.y+")"}),d.exit().transition().duration(1e3).attr("transform",function(a){return"rotate(0)translate(0)"}).remove(),c.exit().transition().duration(1e3).attr("d",origin).remove()},redraw()}}();var openscrape;openscrape||(openscrape={}),function(){openscrape.warn=function(a){console.log(a)}}();